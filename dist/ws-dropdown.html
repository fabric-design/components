<!-- inject:global -->
<!-- endinject -->
<template>
    <div class="ws-dropdown">
        <!-- inject:html -->
        <template id="ws-dropdown-menu">
    <ul class="dropdown-menu">
    </ul>

    <template id="ws-dropdown-menu-item">
        <li class="dropdown-item">
            <a class="text"></a>
            <ws-dropdown-menu></ws-dropdown-menu>
        </li>
    </template>

    <template id="ws-dropdown-menu-back-item">
        <li class="dropdown-item">
            <a class="text">
                &lsaquo; Back
            </a>
        </li>
    </template>
</template>

        <template id="ws-dropdown">
    <div class="dropdown">
        <content select="button,a" id='content'></content>
        <div class="dropdown-container" style="z-index: 1;">
            <ws-dropdown-menu></ws-dropdown-menu>
            <div class="dropdown-arrow"></div>
        </div>
    </div>
</template>
        <!-- endinject -->
    </div>
    <style>
        ws-dropdown > .light-dom {
            display: none;
        }
        /* inject:styles */
        /* endinject */
    </style>
</template>

<script>
(function(){
    /* inject:js */
    'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var template = (document._currentScript || document.currentScript).ownerDocument.querySelector('template');

var GO_BACK_EVENT = 'go-back';
var SIZE_CHANGE_EVENT = 'size-change';
var CHANGE_EVENT = 'change';
var state = {
    hasParent: false,
    items: [],
    openSubMenu: null,
    open: false
};

var WSDropdownMenu = function (_HTMLElement) {
    _inherits(WSDropdownMenu, _HTMLElement);

    function WSDropdownMenu() {
        _classCallCheck(this, WSDropdownMenu);

        return _possibleConstructorReturn(this, (WSDropdownMenu.__proto__ || Object.getPrototypeOf(WSDropdownMenu)).apply(this, arguments));
    }

    _createClass(WSDropdownMenu, [{
        key: 'createdCallback',

        // Use createdCallback instead of constructor to init an element.
        value: function createdCallback() {
            this.rootTemplate = template.content.getElementById('ws-dropdown-menu').content;
            var clone = document.importNode(this.rootTemplate, true);

            // This element uses Shadow DOM.
            this.appendChild(clone);

            this.state = state;
            this.grabElements();
            this.getAttributes();
            this.setupListeners();
        }
    }, {
        key: 'grabElements',
        value: function grabElements() {
            this.menuContainer = this.querySelector('.dropdown-menu');
        }
    }, {
        key: 'draw',
        value: function draw() {
            var _state = this.state,
                hasParent = _state.hasParent,
                items = _state.items;

            this.cleanListItems();
            this.checkIfRoot(hasParent, items);
            this.addItems(items);
        }
    }, {
        key: 'getAttributes',
        value: function getAttributes() {
            try {
                var itemsAttributeValue = this.getAttribute('items');
                var hasParentAttribute = this.getAttribute('has-parent');
                this.state = Object.assign({}, this.state, {
                    items: itemsAttributeValue && JSON.parse(itemsAttributeValue),
                    hasParent: hasParentAttribute ? JSON.parse(hasParentAttribute) : false
                });

                // if attributes change redraw
                this.draw();
            } catch (e) {
                var message = 'Getting Attributes failed: ' + e.message;
                this.propagateError(message);
            }
        }
    }, {
        key: 'setupListeners',
        value: function setupListeners() {
            this.menuContainer.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }
    }, {
        key: 'checkIfRoot',
        value: function checkIfRoot(hasParent, items) {
            var _this2 = this;

            var classes = 'dropdown-menu';
            if (!hasParent) {
                classes += ' dropdown-root-menu';
            } else {
                var goBackItem = document.importNode(this.rootTemplate.getElementById('ws-dropdown-menu-back-item').content, true).querySelector('li');
                goBackItem.addEventListener('click', function () {
                    return _this2.propagateGoBack();
                });
                this.menuContainer.appendChild(goBackItem);
            }
            this.menuContainer.className = classes;
        }
    }, {
        key: 'addItems',
        value: function addItems(items) {
            var _this3 = this;

            if (!items) {
                return;
            }
            items.forEach(function (item) {
                var listItem = _this3.prepareListItem(item);
                _this3.menuContainer.appendChild(listItem);
            });
        }
    }, {
        key: 'cleanListItems',
        value: function cleanListItems() {
            this.menuContainer.innerHTML = '';
        }
    }, {
        key: 'prepareListItem',
        value: function prepareListItem(item) {
            var _this4 = this;

            var classes = 'text';
            var listItem = document.importNode(this.rootTemplate.getElementById('ws-dropdown-menu-item').content.querySelector('li'), true);
            var linkItem = listItem.querySelector('a');
            // styling is based on the .text elem and not the li elem
            var textItem = listItem.querySelector('.text');
            var selected = item.selected,
                href = item.href,
                icon = item.icon,
                label = item.label,
                children = item.children;


            if (selected) {
                classes += ' is-active';
            }
            textItem.className = classes;

            if (icon) {
                var iconItem = document.createElement("i");
                iconItem.className = 'icon ' + icon;
                linkItem.appendChild(iconItem);
            }

            linkItem.textContent = label || item;

            var subMenuItem = listItem.querySelector('ws-dropdown-menu');
            if (children && children.length > 0) {
                subMenuItem.setAttribute('items', JSON.stringify(children));
                subMenuItem.setAttribute('has-parent', true);
                this.setupSubmenuListeners(subMenuItem);
            } else {
                subMenuItem.remove();
            }

            // having a link and an item is not desired
            if (href) {
                linkItem.setAttribute('href', href);
            } else {
                linkItem.addEventListener('click', function () {
                    return _this4.next(item, subMenuItem);
                });
            }

            return listItem;
        }
    }, {
        key: 'next',
        value: function next(item, subMenu) {
            // Show next menu if children are available
            if (item.children && item.children.length) {
                this.state.openSubMenu = subMenu;
                this.propagateNewMenuSize(subMenu.height);
                this.animateOut();
                subMenu.animateIn();
            } else if (item) {
                this.propagateChange(item);
            } else {
                this.propagateClick(item);
            }
            return false;
        }
    }, {
        key: 'back',
        value: function back() {
            if (this.state.openSubMenu) {
                this.state.openSubMenu.animateOut(this.state.openSubMenu.state.hasParent);
                this.propagateNewMenuSize(this.height);
                this.animateIn(this.state.hasParent);
                this.state.openSubMenu = null;
            }
        }
    }, {
        key: 'animateIn',
        value: function animateIn(goBack) {
            this.state.open = true;
            var inAnimation = goBack ? 'animate-in' : 'animate-sub-in';
            // Create a clone of new sub menu for animations
            this.animateElement(this.menuContainer, inAnimation, function (menu) {
                menu.classList.remove('mod-sub-open');
                menu.classList.add('mod-menu-open');
            });
        }
    }, {
        key: 'animateOut',
        value: function animateOut(goBack) {
            this.state.open = false;
            var outAnimation = !goBack ? 'animate-out' : 'animate-sub-out';
            // Fade out old element and set mod-item-open if going back and mod-sub-open for going deeper
            this.animateElement(this.menuContainer, outAnimation, function (menu) {
                menu.classList.remove('mod-menu-open');
                if (!goBack) {
                    menu.classList.add('mod-sub-open');
                }
            });
        }
    }, {
        key: 'animateElement',
        value: function animateElement(item, animationClass, callback) {
            // Define callback for animation end events
            var getHandler = function getHandler(eventName) {
                var handler = function handler(event) {
                    item.classList.remove(animationClass);
                    item.removeEventListener(eventName, handler);
                    callback(item);
                };
                return handler;
            };
            // Listen for all possible animation end events
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = animationEndEvents[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var eventName = _step.value;

                    item.addEventListener(eventName, getHandler(eventName));
                }
                // Add class to start animation
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator.return) {
                        _iterator.return();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }

            item.classList.add(animationClass);
        }
    }, {
        key: 'close',
        value: function close() {
            this.menuContainer.classList.remove('mod-sub-open');
            this.menuContainer.classList.remove('mod-menu-open');
            if (!!this.state.openSubMenu) {
                this.state.openSubMenu.close();
            }
        }
    }, {
        key: 'setupSubmenuListeners',
        value: function setupSubmenuListeners(subMenuElement) {
            var _this5 = this;

            subMenuElement.addEventListener(GO_BACK_EVENT, function (e) {
                e.preventDefault();
                _this5.back();
            });
            subMenuElement.addEventListener(CHANGE_EVENT, function (e) {
                e.preventDefault();
                e.stopPropagation();
                _this5.propagateChange(e.detail.item);
            });
        }
    }, {
        key: 'propagateGoBack',
        value: function propagateGoBack() {
            var event = new CustomEvent(GO_BACK_EVENT);
            this.dispatchEvent(event);
        }
    }, {
        key: 'propagateNewMenuSize',
        value: function propagateNewMenuSize(newSize) {
            var event = new CustomEvent(SIZE_CHANGE_EVENT, {
                detail: {
                    menuSize: newSize
                }
            });
            this.dispatchEvent(event);
        }
    }, {
        key: 'propagateError',
        value: function propagateError(reason) {
            var event = new CustomEvent("error", {
                detail: {
                    message: reason
                }
            });
            this.dispatchEvent(event);
        }
    }, {
        key: 'propagateChange',
        value: function propagateChange(item) {
            var event = new CustomEvent(CHANGE_EVENT, {
                detail: {
                    item: item
                }
            });
            this.dispatchEvent(event);
        }
    }, {
        key: 'propagateClick',
        value: function propagateClick(item) {
            var event = new CustomEvent('click', {
                detail: {
                    item: item
                }
            });
            this.dispatchEvent(event);
        }
    }, {
        key: 'attributeChangedCallback',
        value: function attributeChangedCallback(attrName, oldVal, newVal) {
            switch (attrName) {
                case "items":
                case "has-parent":
                    this.getAttributes();
                    break;
            }
        }
    }, {
        key: 'height',
        get: function get() {
            return this.menuContainer.clientHeight;
        }
    }]);

    return WSDropdownMenu;
}(HTMLElement);

//Register the element with the document


document.registerElement('ws-dropdown-menu', WSDropdownMenu);
    'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var template = (document._currentScript || document.currentScript).ownerDocument.querySelector('template');

var SIZE_CHANGE_EVENT = 'size-change';
var state = {
    items: [], // {selected, href, icon, label, children}
    open: false,
    isSelect: false,
    bodyClickHandler: null,
    selectedItem: null,
    orientation: 'right' // right,left
};
var animationEndEvents = ['oAnimationEnd', 'MSAnimationEnd', 'animationend'];

var WSDropdown = function (_HTMLElement) {
    _inherits(WSDropdown, _HTMLElement);

    function WSDropdown() {
        _classCallCheck(this, WSDropdown);

        return _possibleConstructorReturn(this, (WSDropdown.__proto__ || Object.getPrototypeOf(WSDropdown)).apply(this, arguments));
    }

    _createClass(WSDropdown, [{
        key: 'createdCallback',

        // Use createdCallback instead of constructor to init an element.
        value: function createdCallback() {
            var clone = document.importNode(template.content.getElementById('ws-dropdown').content, true);
            var styleElement = template.content.querySelector('style').cloneNode(true);

            // This element uses Shadow DOM.
            this.createShadowRoot().appendChild(clone);
            this.shadowRoot.appendChild(styleElement);

            this.state = state;
        }
    }, {
        key: 'grabElements',
        value: function grabElements() {
            this.dropdownContainer = this.shadowRoot.querySelector('.dropdown-container');
            this.dropdownMenu = this.shadowRoot.querySelector('ws-dropdown-menu');
            this.button = this.querySelector('button,a');
        }
    }, {
        key: 'getAttributes',
        value: function getAttributes() {
            var itemsAttributeValue = this.getAttribute('items');
            var items = itemsAttributeValue ? JSON.parse(itemsAttributeValue) : [];
            var isSelectAttributeValue = this.getAttribute('is-select');
            var isSelect = isSelectAttributeValue ? isSelectAttributeValue.toLowerCase() === 'true' : false;
            this.state = Object.assign({}, this.state, {
                items: items,
                isSelect: isSelect,
                selectedItem: this.state.selectedItem ? this.state.selectedItem : this.getSelectedItem(items),
                orientation: this.getAttribute('orientation')
            });
        }

        // will grad first selected to display initially

    }, {
        key: 'getSelectedItem',
        value: function getSelectedItem(items) {
            var _this2 = this;

            var selectedItem = items.find(function (item) {
                return item.selected;
            });
            if (!selectedItem) {
                selectedItem = items.reduce(function (selectedItem, item) {
                    if (selectedItem) return;
                    if (item.children) return _this2.getSelectedItem(item.children);
                    return;
                }, selectedItem);
            }
            return selectedItem;
        }
    }, {
        key: 'draw',
        value: function draw() {
            this.dropdownContainer.classList.remove("left", "right");
            this.dropdownContainer.classList.add(this.state.orientation);

            this.dropdownMenu.setAttribute('items', JSON.stringify(this.state.items));

            if (this.state.isSelect && this.state.selectedItem) {
                var span = this.button.querySelector('span');
                var label = this.state.selectedItem.label;
                if (span) {
                    this.button.querySelector('span').textContent = label;
                } else {
                    this.button.textContent = label;
                }
            }
        }
    }, {
        key: 'drawSelected',
        value: function drawSelected() {
            var span = this.button.querySelector('span');
            var label = this.state.selectedItem.label;
            if (span) {
                this.button.querySelector('span').textContent = label;
            } else {
                this.button.textContent = label;
            }
        }
    }, {
        key: 'setupListeners',
        value: function setupListeners() {
            var _this3 = this;

            this.dropdownMenu.addEventListener(SIZE_CHANGE_EVENT, function (e) {
                e.stopPropagation();
                e.preventDefault();
                _this3.adjustSize(e.detail.menuSize);
            });
            // this event will bubble up to the listener outside
            this.dropdownMenu.addEventListener('change', function (e) {
                _this3.state.selectedItem = e.detail.item;
                _this3.draw();
                _this3.state.open ? _this3.close() : _this3.open();
            });
            this.dropdownMenu.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                _this3.state.open ? _this3.close() : _this3.open();
            });
            this.button.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                _this3.state.open ? _this3.close() : _this3.open();
            });

            this.state.bodyClickHandler = function () {
                return _this3.close();
            };
        }
    }, {
        key: 'open',
        value: function open(event) {
            this.state.open = true;

            this.dropdownContainer.style.height = 0;
            this.dropdownContainer.classList.add('mod-open');
            this.dropdownMenu.animateIn();
            this.adjustSize(this.dropdownMenu.height);

            document.body.addEventListener('click', this.state.bodyClickHandler);
        }

        /**
         * Hide the drop down on clicking outside of dropdown
         */

    }, {
        key: 'close',
        value: function close() {
            var _this4 = this;

            this.state.open = false;

            document.body.removeEventListener('click', this.state.bodyClickHandler);

            this.animateElement(this.dropdownContainer, 'animate-close', function (container) {
                container.classList.remove('mod-open');
                _this4.dropdownMenu.close();
            });
        }
    }, {
        key: 'adjustSize',
        value: function adjustSize(newSize) {
            this.dropdownContainer.style.height = newSize + 'px';
        }
    }, {
        key: 'animateElement',
        value: function animateElement(item, animationClass, callback) {
            // Define callback for animation end events
            var getHandler = function getHandler(eventName) {
                var handler = function handler(event) {
                    item.classList.remove(animationClass);
                    item.removeEventListener(eventName, handler);
                    callback(item);
                };
                return handler;
            };
            // Listen for all possible animation end events
            animationEndEvents.forEach(function (eventName) {
                item.addEventListener(eventName, getHandler(eventName));
            });
            // Add class to start animation
            item.classList.add(animationClass);
        }
    }, {
        key: 'propagateError',
        value: function propagateError(reason) {
            var event = new CustomEvent("error", {
                detail: {
                    message: reason
                }
            });
            this.dispatchEvent(event);
        }
    }, {
        key: 'attachedCallback',
        value: function attachedCallback() {
            this.grabElements();
            this.getAttributes();
            this.draw();
            this.setupListeners();
            this.adjustSize(this.dropdownMenu);
        }
    }, {
        key: 'attributeChangedCallback',
        value: function attributeChangedCallback(attrName, oldVal, newVal) {
            switch (attrName) {
                case "items":
                case "is-select":
                case "orientation":
                    this.getAttributes();
                    this.draw();
                    break;
            }
        }
    }, {
        key: 'value',
        get: function get() {
            return this.state.selectedItem ? this.state.selectedItem.value : null;
        }
    }]);

    return WSDropdown;
}(HTMLElement);

//Register the element with the document


document.registerElement('ws-dropdown', WSDropdown);
    function applyTemplate(containerElem, template) {
	'use strict';

	addLightDom(containerElem, template);

	var innerContainerSelector = '.' + containerElem.tagName.toLowerCase();

	var observer = new MutationObserver(function(mutations) {
		var changed = false;
		mutations.forEach(function(mutation) {
			var target = mutation.target;
			if (target === containerElem) {
				return;
			}
			if (target instanceof Text) {
				// text elements have no closest function
				target = target.parentNode;
			}
			// ignore changes inside of pseudo shadow dom
			if(target.closest(innerContainerSelector)) {
				return;
			}

			// console.log('Mutation:', mutation);
			changed = true;
		});

		if (changed) {
			addLightDom(containerElem, containerElem.querySelector(innerContainerSelector));
		}
	});

	// Konfiguration des Observers: alles melden - Ã„nderungen an Daten, Kindelementen und Attributen
	var config = {
		attributes: true,
		childList: true,
		characterData: true,
		subtree:true
	};

	observer.observe(containerElem, config);
}

function addLightDom(containerElem, template) {
	'use strict';

	var innerContainerSelector = '.' + containerElem.tagName.toLowerCase();

	let contentTags = template.querySelectorAll('content');
	Array.from(contentTags).forEach(contentTag => {
		contentTag.innerHTML = '';
		let selection = contentTag.getAttribute('select');
		if (selection) {
			let selectedLightDomElems = Array.from(containerElem.querySelectorAll(selection))
				.filter(elem => !elem.closest(innerContainerSelector));

			selectedLightDomElems.forEach(selectedLightDomElem => {
				var clone = selectedLightDomElem.cloneNode(true);
				contentTag.appendChild(clone);
			});
		}
	});

	var lightDom = Array.from(containerElem.children).filter(elem => {
		return elem.classList
			&& !elem.classList.contains(innerContainerSelector.substr(1));
	});
	for(var child of lightDom) {
		if (!child.classList.contains('light-dom')) {
			child.classList.add('light-dom');
		}
	}

	containerElem.appendChild(template);
}

    /* endinject */
})()
</script>
